![github workflow](https://github.com/dlehammer/gradle-22466-multiple-plugin-test-demo/actions/workflows/gradle.yml/badge.svg)

# :white_check_mark: Gradle TestKit workaround for combining multiple plugins

## :dart: Purpose

This Gradle project demonstrates a workaround for
a [known issue in GradleRunner.withPluginClasspath(..)](https://github.com/gradle/gradle/issues/22466), when attempting
to verify custom plugin behaviour in combination with other plugins.

### :placard: Introduction

This project defines a custom plugin that expands the default `build-info.properties` generated by
the [org.springframework.boot](https://plugins.gradle.org/plugin/org.springframework.boot) plugin `bootJar` task.

The custom plugin appends a custom property
in [DemoPlugin](src/main/java/multiple/plugin/test/demo/DemoPlugin.java).

### :warning: Symptom

The symptom typically looks something like the below excerpt

```
SNIP..

* What went wrong:
An exception occurred applying plugin request [id: 'multiple-plugin-test-demo', version: '1.2.3']
> Failed to apply plugin 'multiple-plugin-test-demo'.
   > Could not create plugin of type 'DemoPlugin'.
      > Could not generate a decorated class for type DemoPlugin.
         > org/springframework/boot/gradle/tasks/buildinfo/BuildInfoProperties

* Try:
> Run with --info or --debug option to get more log output.
> Run with --scan to get full insights.
> Get more help at https://help.gradle.org.

* Exception is:
org.gradle.api.plugins.InvalidPluginException: An exception occurred applying plugin request [id: 'multiple-plugin-test-demo', version: '1.2.3']
	SNIP..
Caused by: org.gradle.api.internal.plugins.PluginApplicationException: Failed to apply plugin 'multiple-plugin-test-demo'.
	SNIP..
Caused by: org.gradle.api.plugins.PluginInstantiationException: Could not create plugin of type 'DemoPlugin'.
	SNIP..
Caused by: org.gradle.internal.instantiation.ClassGenerationException: Could not generate a decorated class for type DemoPlugin.
	SNIP..
Caused by: java.lang.NoClassDefFoundError: org/springframework/boot/gradle/tasks/buildinfo/BuildInfoProperties
	SNIP..
Caused by: java.lang.ClassNotFoundException: org.springframework.boot.gradle.tasks.buildinfo.BuildInfoProperties
	at org.gradle.internal.classloader.VisitableURLClassLoader$InstrumentingVisitableURLClassLoader.findClass(VisitableURLClassLoader.java:189)
	... 201 more


BUILD FAILED in 9s
```

The root cause is the `ClassNotFoundException`, see the Gradle [issue](https://github.com/gradle/gradle/issues/22466)
for further details.

### :hammer: Workaround

This workaround utilizes Gradle support for Maven publishing and repositories, in-order to generate a classpath
supporting Gradle TestKit testing with multiple plugins.

The main ingredients behind are

1. [build.gradle](build.gradle) utilizes the `maven-publish` plugin.
    1. A custom repository is defined for publishing to a local directory.
    1. The `test` task depends on the `publishAllPublicationsToTestMavenLocalRepository` task, that Gradle generates
       automatically, triggered by the custom publising repository.
1. [DemoPluginSpec.groovy](src/test/groovy/multiple/plugin/test/demo/DemoPluginSpec.groovy)
    1. The `build.gradle` injected into the dynamically generated Gradle `my-project` defines `mavenLocal()`.
    2. Overrides the default `maven.repo.local` configuration. 
